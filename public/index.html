<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Watch Video</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- ========== MONETAG REWARDED AD SDK ========== -->
  <script src='//libtl.com/sdk.js' data-zone='9981288' data-sdk='show_9981288'></script>
  <!-- ============================================== -->
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      padding: 10px;
    }

    .container {
      background: #1a1a1a;
      padding: 18px;
      border-radius: 14px;
      max-width: 480px;
      margin: 0 auto;
    }

    h1 {
      font-size: 19px;
      margin-bottom: 6px;
      text-align: center;
    }

    #subtitle {
      color: #999;
      margin-bottom: 14px;
      font-size: 13px;
      text-align: center;
    }

    /* ========== TOP BANNER AD (Above Button) ========== */
    .ad-top {
      margin-bottom: 14px;
      text-align: center;
      min-height: 50px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* ================================================== */

    .btn {
      background: linear-gradient(135deg, #32b8c6, #28a0ac);
      border: none;
      padding: 13px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      color: #000;
      font-weight: 700;
      width: 100%;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(50, 184, 198, 0.3);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    /* ========== BOTTOM BANNER AD (Below Button) ========== */
    .ad-bottom {
      margin-top: 14px;
      text-align: center;
      min-height: 50px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* ==================================================== */

    #error-msg {
      margin-top: 12px;
      color: #ff4444;
      font-size: 13px;
      text-align: center;
    }

    #video-container {
      display: none;
      margin-top: 18px;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
    }

    video {
      width: 100%;
      display: block;
      background: #000;
    }

    /* ========== HIDE NATIVE FULLSCREEN BUTTON ========== */
    video::-webkit-media-controls-fullscreen-button {
      display: none !important;
    }
    video::-moz-media-controls-fullscreen-button {
      display: none !important;
    }
    /* ==================================================== */

    /* ========== MAKE VIDEO CONTROLS WHITE/VISIBLE ========== */
    video::-webkit-media-controls-panel {
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent) !important;
    }
    video::-webkit-media-controls-play-button,
    video::-webkit-media-controls-timeline,
    video::-webkit-media-controls-current-time-display,
    video::-webkit-media-controls-time-remaining-display,
    video::-webkit-media-controls-mute-button,
    video::-webkit-media-controls-volume-slider {
      filter: brightness(1.5) contrast(1.2);
    }
    /* ======================================================= */

    .fs-btn {
      position: absolute;
      bottom: 56px;
      right: 12px;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 40px;
      height: 40px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.2s;
    }

    .fs-btn:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.9);
    }

    .fs-btn svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    /* ========== FULLSCREEN MODE ========== */
    .video-wrapper.fs-active {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
      z-index: 999999 !important;
      border-radius: 0 !important;
      background: #000 !important;
    }

    .video-wrapper.fs-active video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      object-fit: contain;
    }

    .video-wrapper.fs-active .fs-btn {
      position: fixed;
      bottom: 70px;
      right: 16px;
      z-index: 1000000;
      background: rgba(0, 0, 0, 0.85);
    }

    body.no-scroll {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    /* ====================================== */

    .video-info {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(0,0,0,0.3);
      border-radius: 50%;
      border-top-color: #000;
      animation: spin 0.5s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="video-title">Loading...</h1>
    <p id="subtitle">Preparing video...</p>
    
    <!-- ========== TOP BANNER AD (Above Button) ========== -->
    <div class="ad-top" id="ad-top"></div>
    <!-- ================================================== -->
    
    <button id="watch-btn" class="btn" onclick="startWatch()">
      Watch Video ðŸŽ¬
    </button>
    
    <!-- ========== BOTTOM BANNER AD (Below Button) ========== -->
    <div class="ad-bottom" id="ad-bottom"></div>
    <!-- ==================================================== -->
    
    <div id="error-msg"></div>
    
    <div id="video-container">
      <div class="video-wrapper" id="vw">
        <video id="vp" controls playsinline webkit-playsinline preload="metadata" controlsList="nodownload"></video>
        
        <button class="fs-btn" id="fs-btn" onclick="toggleFS()" title="Fullscreen">
          <svg id="fs-icon" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
        </button>
      </div>
      <div class="video-info" id="video-info"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    let vTitle = null;
    let vId = null;
    let isFS = false;
    let isLandscape = false;
    const API = window.location.origin + '/api';

    function err(msg) {
      document.getElementById('error-msg').textContent = msg;
    }

    function getVID() {
      const sp = tg.initDataUnsafe?.start_param || '';
      if (sp) return sp;
      const params = new URLSearchParams(window.location.search);
      return params.get('video_id') || 'vid_1';
    }

    // Load ads immediately
    function loadAds() {
      // TOP AD
      const topScript = document.createElement('script');
      topScript.async = true;
      topScript.setAttribute('data-cfasync', 'false');
      topScript.src = '//pl27977828.effectivegatecpm.com/257f53d4a564585de9b5b359319941c3/invoke.js';
      document.head.appendChild(topScript);

      const topDiv = document.createElement('div');
      topDiv.id = 'container-257f53d4a564585de9b5b359319941c3';
      document.getElementById('ad-top').appendChild(topDiv);

      // BOTTOM AD
      window.atOptions = {
        'key': '3fc8a11a10d75d1b796ff86d8cc395c9',
        'format': 'iframe',
        'height': 50,
        'width': 320,
        'params': {}
      };
      const botScript = document.createElement('script');
      botScript.type = 'text/javascript';
      botScript.src = '//www.highperformanceformat.com/3fc8a11a10d75d1b796ff86d8cc395c9/invoke.js';
      document.getElementById('ad-bottom').appendChild(botScript);
    }

    async function init() {
      vId = getVID();
      
      if (!vId) {
        err('No video ID');
        document.getElementById('watch-btn').disabled = true;
        return;
      }

      try {
        const res = await fetch(`${API}/init?video_id=${encodeURIComponent(vId)}`);
        const data = await res.json();

        if (!data.success) {
          err(data.error || 'Failed to load');
          document.getElementById('watch-btn').disabled = true;
          return;
        }

        vTitle = data.video.title;
        document.getElementById('video-title').textContent = vTitle || 'Watch Video';
        document.getElementById('subtitle').textContent = 'Click button to watch';

        // Load ads after init
        loadAds();

      } catch (e) {
        err('Connection error: ' + e.message);
        document.getElementById('watch-btn').disabled = true;
      }
    }

    async function startWatch() {
      const btn = document.getElementById('watch-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>Loading Ad...';

      try {
        // ========== MONETAG REWARDED AD ========== 
        if (window.show_9981288) {
          await show_9981288();
        }
        // =========================================
        
        btn.innerHTML = '<span class="loading"></span>Loading Video...';
        await loadVideo();

      } catch (e) {
        btn.innerHTML = '<span class="loading"></span>Loading Video...';
        await loadVideo();
      }
    }

    async function loadVideo() {
      try {
        const res = await fetch(`${API}/get-video?video_id=${encodeURIComponent(vId)}`);
        const data = await res.json();

        if (!data.success) {
          err(data.error || 'Failed to load video');
          document.getElementById('watch-btn').disabled = false;
          document.getElementById('watch-btn').textContent = 'Retry';
          return;
        }

        showVideo(data.video);

      } catch (e) {
        err('Failed: ' + e.message);
        document.getElementById('watch-btn').disabled = false;
        document.getElementById('watch-btn').textContent = 'Retry';
      }
    }

    function showVideo(vid) {
      err('');
      document.getElementById('watch-btn').style.display = 'none';
      document.getElementById('subtitle').style.display = 'none';
      document.getElementById('ad-bottom').style.display = 'none';
      
      const vp = document.getElementById('vp');
      const info = document.getElementById('video-info');
      
      vp.src = vid.video_url;
      info.textContent = vid.title || '';
      
      document.getElementById('video-container').style.display = 'block';
      
      vp.load();
      
      vp.addEventListener('loadedmetadata', () => {
        isLandscape = vp.videoWidth > vp.videoHeight;
        console.log(`Video: ${vp.videoWidth}x${vp.videoHeight}, Landscape: ${isLandscape}`);
      });

      vp.play().catch(() => {});

      vp.addEventListener('error', () => {
        err('Playback error');
      });
    }

    function toggleFS() {
      const vw = document.getElementById('vw');
      const icon = document.getElementById('fs-icon');
      
      if (!isFS) {
        // Enter fullscreen
        vw.classList.add('fs-active');
        document.body.classList.add('no-scroll');
        
        // Lock to landscape if video is landscape
        if (isLandscape) {
          lockLandscape();
        }
        
        // Native fullscreen API
        if (vw.requestFullscreen) vw.requestFullscreen();
        else if (vw.webkitRequestFullscreen) vw.webkitRequestFullscreen();
        else if (vw.mozRequestFullScreen) vw.mozRequestFullScreen();
        
        // Exit icon
        icon.innerHTML = '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>';
        
        isFS = true;
      } else {
        exitFS();
      }
    }

    function exitFS() {
      const vw = document.getElementById('vw');
      const icon = document.getElementById('fs-icon');
      
      vw.classList.remove('fs-active');
      document.body.classList.remove('no-scroll');
      
      unlockOrientation();
      
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
      
      icon.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
      
      isFS = false;
    }

    function lockLandscape() {
      const orient = screen.orientation || screen.mozOrientation || screen.msOrientation;
      if (orient && orient.lock) {
        orient.lock('landscape').catch(() => {});
      }
    }

    function unlockOrientation() {
      const orient = screen.orientation || screen.mozOrientation || screen.msOrientation;
      if (orient && orient.unlock) {
        orient.unlock();
      }
    }

    // Handle ESC and back button
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) exitFS();
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (!document.webkitFullscreenElement) exitFS();
    });

    init();
  </script>
</body>
</html>
