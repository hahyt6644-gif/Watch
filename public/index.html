<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Watch Video</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag -->
<script src="//libtl.com/sdk.js"
        data-zone="9981288"
        data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

html,body{
  width:100%;
  height:100%;
  background:#f2f3f5;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
}

/* ---------- UI CARD ---------- */
#ui{
  padding:16px;
}
.card{
  max-width:520px;
  margin:auto;
  background:#111;
  color:#fff;
  padding:18px;
  border-radius:16px;
  text-align:center;
}
.card h2{
  margin-bottom:8px;
}
.card p{
  opacity:.7;
  margin-bottom:14px;
}
.card button{
  width:100%;
  padding:14px;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:12px;
  background:#22b8b0;
  cursor:pointer;
}
.card button:disabled{
  opacity:.6;
}

/* ---------- PLAYER ---------- */
#player{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:999999;
}

/* iframe container */
#frame-wrap{
  width:100vw;
  height:100vh;
  overflow:hidden;
}
#frame-wrap iframe{
  width:100vw;
  height:100vh;
  border:none;
  transform:scale(1.12);   /* IMPORTANT: makes video bigger */
  transform-origin:center;
}

/* top bar */
#topbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  height:48px;
  background:#fff;
  display:flex;
  align-items:center;
  padding:0 12px;
  z-index:1000000;
}
#topbar button{
  background:none;
  border:none;
  font-size:16px;
  font-weight:700;
}
</style>
</head>

<body>

<!-- UI -->
<div id="ui">
  <div class="card">
    <h2 id="title">Loading‚Ä¶</h2>
    <p>Watch ad to unlock video</p>
    <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
  </div>
</div>

<!-- PLAYER -->
<div id="player">
  <div id="topbar">
    <button onclick="goBack()">‚Üê Back</button>
  </div>
  <div id="frame-wrap">
    <iframe id="playerFrame" allow="autoplay"></iframe>
  </div>
</div>

<script>
/* ---------- TELEGRAM ---------- */
const tg = window.Telegram?.WebApp || {};
tg.expand?.();
tg.ready?.();

/* ---------- CONFIG ---------- */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";
let shareURL = "";

/* ---------- LOAD TITLE FAST ---------- */
(async ()=>{
  try{
    const r = await fetch(`${API}?video_id=${videoId}`);
    const d = await r.json();
    if(d.success && d.video){
      document.getElementById("title").textContent =
        d.video.title || "Watch Video";
      shareURL = d.video.video_url;
    }else{
      document.getElementById("title").textContent = "Video not found";
    }
  }catch{
    document.getElementById("title").textContent = "Error loading video";
  }
})();

/* ---------- WATCH FLOW ---------- */
async function watch(){
  const btn = document.getElementById("watchBtn");
  btn.disabled = true;
  btn.textContent = "Loading...";

  // 1Ô∏è‚É£ Try showing ad (never block)
  await showAdSafe(6000);

  // 2Ô∏è‚É£ Always open video
  openPlayer();
}

/* ---------- SAFE AD (NO STUCK EVER) ---------- */
function showAdSafe(timeout=6000){
  return new Promise(resolve=>{
    let done=false;

    function finish(reason){
      if(done) return;
      done=true;
      console.log("Ad finished:", reason);
      resolve();
    }

    const t = setTimeout(()=>finish("timeout"), timeout);

    try{
      show_9981288({
        onRewarded:()=>{clearTimeout(t);finish("rewarded");},
        onClose:()=>{clearTimeout(t);finish("closed");},
        onError:()=>{clearTimeout(t);finish("error");}
      });
    }catch{
      clearTimeout(t);
      finish("exception");
    }
  });
}

/* ---------- PLAYER CONTROL ---------- */
function openPlayer(){
  document.getElementById("ui").style.display="none";

  const frame = document.getElementById("playerFrame");
  frame.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(shareURL);

  document.getElementById("player").style.display="block";

  // force landscape if possible
  screen.orientation?.lock("landscape").catch(()=>{});
}

function goBack(){
  document.getElementById("player").style.display="none";
  document.getElementById("playerFrame").src="";
  document.getElementById("ui").style.display="block";

  const btn = document.getElementById("watchBtn");
  btn.disabled = false;
  btn.textContent = "Watch Video üé¨";

  screen.orientation?.unlock?.();
}
</script>

</body>
</html>
