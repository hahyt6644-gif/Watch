<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Watch Video</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- ========== MONETAG REWARDED AD SDK ========== -->
  <script src='//libtl.com/sdk.js' data-zone='9981288' data-sdk='show_9981288'></script>
  <!-- ============================================== -->
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      background: #000;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #fff;
      padding: 8px;
    }

    .container {
      background: #1a1a1a;
      padding: 16px;
      border-radius: 12px;
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      font-size: 18px;
      margin-bottom: 6px;
      text-align: center;
      font-weight: 600;
    }

    #subtitle {
      color: #999;
      margin-bottom: 12px;
      font-size: 13px;
      text-align: center;
    }

    /* ========== AD ABOVE BUTTON ========== */
    .ad-above {
      margin-bottom: 12px;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* ==================================== */

    .btn {
      background: linear-gradient(135deg, #32b8c6, #28a0ac);
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      color: #000;
      font-weight: 700;
      width: 100%;
      transition: transform 0.1s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* ========== AD BELOW BUTTON ========== */
    .ad-below {
      margin-top: 12px;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* ==================================== */

    #error-msg {
      margin-top: 10px;
      color: #ff4444;
      font-size: 13px;
      text-align: center;
    }

    #video-container {
      display: none;
      margin-top: 16px;
    }

    .video-box {
      position: relative;
      width: 100%;
      overflow: visible;
    }

    video {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
    }

    /* ========== HIDE NATIVE FULLSCREEN BUTTON ========== */
    video::-webkit-media-controls-fullscreen-button {
      display: none !important;
    }
    video::-webkit-media-controls-enclosure {
      border-radius: 0 0 8px 8px;
    }
    /* ==================================================== */

    .fs-btn {
      position: absolute;
      bottom: 54px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .fs-btn svg {
      width: 20px;
      height: 20px;
      fill: #000;
    }

    /* ========== FULLSCREEN MODE ========== */
    body.fs-mode {
      overflow: hidden;
    }

    .video-box.fs {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 999999 !important;
      background: #000 !important;
    }

    .video-box.fs video {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      border-radius: 0;
    }

    .video-box.fs .fs-btn {
      position: fixed;
      bottom: 60px;
      right: 16px;
      z-index: 1000000;
    }
    /* ====================================== */

    .video-info {
      margin-top: 8px;
      text-align: center;
      font-size: 13px;
      color: #aaa;
    }

    .loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(0,0,0,0.3);
      border-radius: 50%;
      border-top-color: #000;
      animation: spin 0.5s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Loading...</h1>
    <p id="subtitle">Preparing video...</p>
    
      
    <button id="btn" class="btn" onclick="watch()">
      Watch Video ðŸŽ¬
    </button>
    
 
    
    <div id="error-msg"></div>
    
    <div id="video-container">
      <div class="video-box" id="vbox">
        <video id="vid" controls playsinline webkit-playsinline preload="metadata" controlsList="nodownload"></video>
        
        <button class="fs-btn" id="fsbtn" onclick="fullscreen()">
          <svg id="fsicon" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
        </button>
      </div>
      <div class="video-info" id="info"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    let vId, vTitle, isFS = false, isLS = false;
    const API = window.location.origin + '/api';

    function err(m) {
      document.getElementById('error-msg').textContent = m;
    }

    function getID() {
      const p = tg.initDataUnsafe?.start_param || new URLSearchParams(location.search).get('video_id');
      return p || 'vid_1';
    }

    

    async function init() {
      vId = getID();
      
      if (!vId) {
        err('No video ID');
        document.getElementById('btn').disabled = true;
        return;
      }

      try {
        const r = await fetch(`${API}/init?video_id=${vId}`);
        const d = await r.json();

        if (!d.success) {
          err(d.error || 'Failed');
          document.getElementById('btn').disabled = true;
          return;
        }

        vTitle = d.video.title;
        document.getElementById('title').textContent = vTitle || 'Watch Video';
        document.getElementById('subtitle').textContent = 'Click to watch';
        loadAds();

      } catch (e) {
        err('Error: ' + e.message);
        document.getElementById('btn').disabled = true;
      }
    }

    async function watch() {
      const b = document.getElementById('btn');
      b.disabled = true;
      b.innerHTML = '<span class="loading"></span>Loading Ad...';

      try {
        if (window.show_9981288) {
          await show_9981288();
        }
        b.innerHTML = '<span class="loading"></span>Loading...';
        await load();
      } catch {
        b.innerHTML = '<span class="loading"></span>Loading...';
        await load();
      }
    }

    async function load() {
      try {
        const r = await fetch(`${API}/get-video?video_id=${vId}`);
        const d = await r.json();

        if (!d.success) {
          err(d.error || 'Failed');
          document.getElementById('btn').disabled = false;
          document.getElementById('btn').textContent = 'Retry';
          return;
        }

        show(d.video);
      } catch (e) {
        err('Failed: ' + e.message);
        document.getElementById('btn').disabled = false;
        document.getElementById('btn').textContent = 'Retry';
      }
    }

    function show(v) {
      err('');
      document.getElementById('btn').style.display = 'none';
      document.getElementById('subtitle').style.display = 'none';
      document.getElementById('ad2').style.display = 'none';
      
      const vid = document.getElementById('vid');
      const inf = document.getElementById('info');
      
      vid.src = v.video_url;
      inf.textContent = v.title || '';
      
      document.getElementById('video-container').style.display = 'block';
      
      vid.load();
      
      vid.addEventListener('loadedmetadata', () => {
        isLS = vid.videoWidth > vid.videoHeight;
      });

      vid.play().catch(() => {});
      vid.addEventListener('error', () => err('Playback error'));
    }

    function fullscreen() {
      const box = document.getElementById('vbox');
      const icon = document.getElementById('fsicon');
      
      if (!isFS) {
        box.classList.add('fs');
        document.body.classList.add('fs-mode');
        
        if (isLS && screen.orientation?.lock) {
          screen.orientation.lock('landscape').catch(() => {});
        }
        
        if (box.requestFullscreen) box.requestFullscreen();
        else if (box.webkitRequestFullscreen) box.webkitRequestFullscreen();
        
        icon.innerHTML = '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>';
        isFS = true;
      } else {
        exit();
      }
    }

    function exit() {
      const box = document.getElementById('vbox');
      const icon = document.getElementById('fsicon');
      
      box.classList.remove('fs');
      document.body.classList.remove('fs-mode');
      
      if (screen.orientation?.unlock) screen.orientation.unlock();
      
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      
      icon.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
      isFS = false;
    }

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) exit();
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (!document.webkitFullscreenElement) exit();
    });

    init();
  </script>
</body>
</html>
