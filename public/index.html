<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Watch Video</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag Rewarded Ad -->
<script src="//libtl.com/sdk.js"
        data-zone="9981288"
        data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  background:#000;
  color:#fff;
  padding:12px;
}

.container{
  max-width:500px;
  margin:auto;
  background:#1a1a1a;
  padding:16px;
  border-radius:12px;
  text-align:center;
}

h1{font-size:18px;margin-bottom:8px}
p{font-size:13px;color:#aaa;margin-bottom:12px}

button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(135deg,#32b8c6,#28a0ac);
  color:#000;
}

button:disabled{opacity:.6;cursor:not-allowed}

#player-wrap{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:99999;
}

#player-wrap iframe{
  width:100%;
  height:100%;
  border:none;
}

#back-btn{
  position:absolute;
  top:12px;
  left:12px;
  z-index:100000;
  padding:8px 12px;
  border-radius:6px;
  border:none;
  background:#fff;
  font-weight:700;
}
</style>
</head>

<body>

<div class="container">
  <h1 id="title">Watch Video</h1>
  <p>Watch ad to unlock video</p>

  <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
</div>

<!-- Fullscreen Player -->
<div id="player-wrap">
  <button id="back-btn" onclick="closePlayer()">‚Üê Back</button>
  <iframe id="playerFrame"
          allow="autoplay; fullscreen"
          allowfullscreen></iframe>
</div>

<script>
const tg = window.Telegram?.WebApp || {};
tg.expand?.();
tg.ready?.();

// CHANGE THIS TO YOUR API
const API = "/api/get-video"; 
let videoId = tg.initDataUnsafe?.start_param || "vid_1";

async function watch(){
  const btn = document.getElementById("watchBtn");
  btn.disabled = true;
  btn.innerText = "Loading...";

  // 1Ô∏è‚É£ Fetch video URL first (so iframe loads during ad)
  let videoURL;
  try{
    const r = await fetch(`${API}?video_id=${videoId}`);
    const d = await r.json();
    if(!d.success) throw "API error";
    videoURL = d.video_url;
  }catch(e){
    btn.disabled=false;
    btn.innerText="Retry";
    alert("Failed to load video");
    return;
  }

  // 2Ô∏è‚É£ Prepare PlayTerabox iframe (background load)
  const iframeURL =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(videoURL);

  const iframe = document.getElementById("playerFrame");
  iframe.src = iframeURL;

  // 3Ô∏è‚É£ Show rewarded ad
  try{
    await new Promise((resolve,reject)=>{
      show_9981288({
        onRewarded: resolve,
        onClose: reject,
        onError: reject
      });
    });
  }catch{
    btn.disabled=false;
    btn.innerText="Watch Video üé¨";
    return;
  }

  // 4Ô∏è‚É£ Ad done ‚Üí open player
  openPlayer();
}

function openPlayer(){
  document.getElementById("player-wrap").style.display="block";
  document.body.style.overflow="hidden";
}

function closePlayer(){
  document.getElementById("player-wrap").style.display="none";
  document.getElementById("playerFrame").src="";
  document.body.style.overflow="";
}
</script>

</body>
</html>
