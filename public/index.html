<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<title>Watch Video</title>

<!-- Telegram WebApp SDK (REQUIRED) -->
<script src="https://telegram.org/js/telegram-web-app.js?59"></script>

<!-- Monetag -->
<script src="//libtl.com/sdk.js"
        data-zone="9981288"
        data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

html,body{
  width:100%;
  height:100%;
  background:#000;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  overflow:hidden;
}

/* ----------- START UI ----------- */
#ui{
  padding:12px;
  background:#f2f3f5;
}
.card{
  max-width:520px;
  margin:auto;
  background:#111;
  color:#fff;
  padding:14px;
  border-radius:14px;
  text-align:center;
}
.card h2{
  font-size:16px;
  margin-bottom:6px;
}
.card p{
  font-size:12px;
  opacity:.65;
  margin-bottom:10px;
}
.card button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:12px;
  background:#22b8b0;
}

/* ----------- PLAYER ----------- */
#player{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:999999;
}

/* fixed controls (safe-area aware) */
.ctrl-btn{
  position:fixed;
  top:calc(10px + var(--tg-safe-area-inset-top));
  z-index:1000000;
  padding:7px 10px;
  border:none;
  border-radius:999px;
  background:rgba(0,0,0,0.6);
  color:#fff;
  font-size:13px;
  font-weight:600;
  backdrop-filter:blur(6px);
}
#backBtn{
  left:calc(10px + var(--tg-safe-area-inset-left));
}
#fsBtn{
  right:calc(10px + var(--tg-safe-area-inset-right));
}

/* video container */
#frame-wrap{
  position:absolute;
  inset:0;
}
#frame-wrap iframe{
  width:100%;
  height:100%;
  border:none;
}
</style>
</head>

<body>

<!-- START SCREEN -->
<div id="ui">
  <div class="card">
    <h2 id="title">Loading‚Ä¶</h2>
    <p>Watch ad to unlock video</p>
    <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
  </div>
</div>

<!-- PLAYER -->
<div id="player">
  <button id="backBtn" class="ctrl-btn" onclick="goBack()">‚Üê</button>
  <button id="fsBtn" class="ctrl-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>

  <div id="frame-wrap">
    <iframe id="playerFrame" allow="autoplay; fullscreen"></iframe>
  </div>
</div>

<script>
/* ================= TELEGRAM ================= */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* ================= CONFIG ================= */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";
let videoURL = "";

/* ================= LOAD VIDEO INFO ================= */
(async ()=>{
  try{
    const r = await fetch(`${API}?video_id=${videoId}`);
    const d = await r.json();
    if(d.success){
      title.textContent = d.video.title;
      videoURL = d.video.video_url;
    }else{
      title.textContent = "Video not found";
    }
  }catch{
    title.textContent = "Error loading video";
  }
})();

/* ================= WATCH FLOW ================= */
async function watch(){
  watchBtn.disabled = true;
  watchBtn.textContent = "Loading...";

  await showAdSafe(6000);
  openPlayer();
}

/* ================= SAFE AD ================= */
function showAdSafe(timeout=6000){
  return new Promise(resolve=>{
    let done=false;
    const finish=()=>{ if(!done){done=true;resolve()} };
    setTimeout(finish,timeout);

    try{
      show_9981288({
        onRewarded:finish,
        onClose:finish,
        onError:finish
      });
    }catch{
      finish();
    }
  });
}

/* ================= PLAYER ================= */
function openPlayer(){
  ui.style.display = "none";
  player.style.display = "block";

  playerFrame.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(videoURL);
}

/* ================= BACK ================= */
function goBack(){
  exitFullscreen();

  player.style.display = "none";
  playerFrame.src = "";

  ui.style.display = "block";
  watchBtn.disabled = false;
  watchBtn.textContent = "Watch Video üé¨";
}

/* ================= FULLSCREEN ================= */
function toggleFullscreen(){
  if(!tg.isFullscreen){
    enterFullscreen();
  }else{
    exitFullscreen();
  }
}

function enterFullscreen(){
  if(tg.isVersionAtLeast("8.0")){
    tg.requestFullscreen();
    tg.lockOrientation();
    fsBtn.textContent = "‚ü≥ Normal";
  }
}

function exitFullscreen(){
  if(tg.isFullscreen){
    tg.exitFullscreen();
    tg.unlockOrientation();
    fsBtn.textContent = "‚õ∂ Fullscreen";
  }
}

/* ================= EVENTS ================= */
tg.onEvent("fullscreenChanged", ()=>{
  fsBtn.textContent = tg.isFullscreen ? "‚ü≥ Normal" : "‚õ∂ Fullscreen";
});

tg.onEvent("fullscreenFailed", ()=>{
  alert("Fullscreen not supported on this device");
});
</script>

</body>
</html>
