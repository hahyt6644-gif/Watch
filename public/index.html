<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Watch Video</title>

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag -->
<script src="//libtl.com/sdk.js"
        data-zone="9981288"
        data-sdk="show_9981288"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

html,body{
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
}

/* UI card */
#ui{
  padding:12px;
}

.container{
  max-width:500px;
  margin:auto;
  background:#1a1a1a;
  padding:16px;
  border-radius:12px;
  text-align:center;
}

h1{
  font-size:18px;
  margin-bottom:8px;
}

button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(135deg,#32b8c6,#28a0ac);
  color:#000;
}

/* PLAYER (MAX SCREEN) */
#player-wrap{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  background:#000;
  z-index:999999;
}

/* iframe forced large */
#player-wrap iframe{
  width:100vw;
  height:100vh;
  border:none;
  transform:scale(1.02); /* slight zoom */
}

/* back button */
#back-btn{
  position:fixed;
  top:8px;
  left:8px;
  z-index:1000000;
  padding:8px 12px;
  border-radius:6px;
  border:none;
  background:rgba(255,255,255,0.95);
  font-weight:700;
}
</style>
</head>

<body>

<div id="ui">
  <div class="container">
    <h1 id="videoTitle">Loading‚Ä¶</h1>
    <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
  </div>
</div>

<!-- PLAYER -->
<div id="player-wrap">
  <button id="back-btn" onclick="closePlayer()">‚Üê Back</button>
  <iframe id="playerFrame"
          allow="autoplay; fullscreen"
          allowfullscreen></iframe>
</div>

<script>
/* TELEGRAM SETUP */
const tg = window.Telegram?.WebApp || {};
tg.expand?.();
tg.ready?.();
tg.enableClosingConfirmation?.();

/* CONFIG */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";
let shareURL = "";

/* LOAD TITLE FAST */
(async ()=>{
  try{
    const r = await fetch(`${API}?video_id=${videoId}`);
    const d = await r.json();
    if(d.success && d.video){
      document.getElementById("videoTitle").textContent =
        d.video.title || "Watch Video";
      shareURL = d.video.video_url;
    }else{
      document.getElementById("videoTitle").textContent = "Video not found";
    }
  }catch{
    document.getElementById("videoTitle").textContent = "Error loading";
  }
})();

/* WATCH FLOW */
async function watch(){
  const btn=document.getElementById("watchBtn");
  btn.disabled=true;
  btn.textContent="Loading...";

  /* show ad first */
  await showAdSafe();

  /* open large player */
  openPlayer();
}

/* SAFE AD */
function showAdSafe(timeout=8000){
  return new Promise(resolve=>{
    let done=false;
    const t=setTimeout(()=>{if(!done){done=true;resolve();}},timeout);

    try{
      show_9981288({
        onRewarded:()=>{if(done)return;done=true;clearTimeout(t);resolve();},
        onClose:()=>{if(done)return;done=true;clearTimeout(t);resolve();},
        onError:()=>{if(done)return;done=true;clearTimeout(t);resolve();}
      });
    }catch{
      clearTimeout(t);
      resolve();
    }
  });
}

/* OPEN LARGE SCREEN */
function openPlayer(){
  document.getElementById("ui").style.display="none";

  const wrap=document.getElementById("player-wrap");
  const iframe=document.getElementById("playerFrame");

  iframe.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(shareURL);

  wrap.style.display="block";

  /* force landscape */
  if(screen.orientation?.lock){
    screen.orientation.lock("landscape").catch(()=>{});
  }
}

/* CLOSE */
function closePlayer(){
  document.getElementById("player-wrap").style.display="none";
  document.getElementById("playerFrame").src="";
  document.getElementById("ui").style.display="block";

  if(screen.orientation?.unlock){
    screen.orientation.unlock();
  }
}
</script>

</body>
</html>
