<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Watch Video</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag Rewarded Ad -->
<script src="//libtl.com/sdk.js"
        data-zone="9981288"
        data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  background:#000;
  color:#fff;
  padding:12px;
}

/* Card */
.container{
  max-width:500px;
  margin:auto;
  background:#1a1a1a;
  padding:16px;
  border-radius:12px;
  text-align:center;
}

h1{font-size:18px;margin-bottom:6px}
p{font-size:13px;color:#aaa;margin-bottom:12px}

button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(135deg,#32b8c6,#28a0ac);
  color:#000;
}
button:disabled{opacity:.6;cursor:not-allowed}

/* Player overlay */
#player-wrap{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:2147483647;
}

#player-wrap iframe{
  width:100%;
  height:100%;
  border:none;
}

/* Back button */
#back-btn{
  position:absolute;
  top:12px;
  left:12px;
  z-index:2147483648;
  padding:8px 12px;
  border-radius:6px;
  border:none;
  background:#fff;
  font-weight:700;
}

/* Logs */
#logBox{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  max-height:35%;
  overflow:auto;
  background:#111;
  border-top:1px solid #333;
  font-size:11px;
  padding:6px;
  z-index:2147483649;
}

.log{margin-bottom:4px}
.ok{color:#4caf50}
.err{color:#f44336}
.info{color:#03a9f4}
</style>
</head>

<body>

<div class="container">
  <h1 id="videoTitle">Watch Video</h1>
  <p>Watch ad to unlock video</p>
  <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
</div>

<!-- Player -->
<div id="player-wrap">
  <button id="back-btn" onclick="closePlayer()">‚Üê Back</button>
  <iframe id="playerFrame"
          allow="autoplay; fullscreen"
          allowfullscreen></iframe>
</div>

<!-- Logs -->
<div id="logBox"></div>

<script>
/* ---------- LOGGING ---------- */
function log(msg,type="info"){
  console.log(msg);
  const box=document.getElementById("logBox");
  const div=document.createElement("div");
  div.className="log "+type;
  div.textContent=new Date().toLocaleTimeString()+" - "+msg;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

/* ---------- TELEGRAM ---------- */
const tg = window.Telegram?.WebApp || {};
tg.expand?.();
tg.ready?.();
log("Telegram WebApp ready","ok");

/* ---------- CONFIG ---------- */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";
log("Video ID: "+videoId,"info");

/* ---------- MAIN ---------- */
async function watch(){
  const btn=document.getElementById("watchBtn");
  btn.disabled=true;
  btn.textContent="Loading...";
  log("Watch clicked","info");

  /* 1Ô∏è‚É£ Fetch video data */
  let data;
  try{
    log("Fetching video data...","info");
    const r = await fetch(`${API}?video_id=${videoId}`);
    data = await r.json();

    if(!data.success || !data.video || !data.video.video_url){
      throw new Error("Invalid API response");
    }

    log("Video data received","ok");
  }catch(e){
    log("No video data found","err");
    btn.disabled=false;
    btn.textContent="Retry";
    return;
  }

  /* 2Ô∏è‚É£ Set title */
  document.getElementById("videoTitle").textContent =
    data.video.title || "Watch Video";
  log("Title set: "+data.video.title,"ok");

  /* 3Ô∏è‚É£ Prepare iframe */
  const iframeURL =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(data.video.video_url);

  const iframe=document.getElementById("playerFrame");
  iframe.src=iframeURL;
  log("Iframe URL set","ok");

  /* 4Ô∏è‚É£ Open player immediately (Telegram-safe) */
  openPlayer();
  log("Player opened","ok");

  /* 5Ô∏è‚É£ Show ad on top */
  setTimeout(()=>{
    try{
      log("Attempting to show ad","info");
      show_9981288({
        onRewarded:()=>log("Ad rewarded","ok"),
        onClose:()=>log("Ad closed","info"),
        onError:()=>log("Ad error","err")
      });
    }catch{
      log("Ad call failed","err");
    }
  },300);
}

/* ---------- PLAYER CONTROLS ---------- */
function openPlayer(){
  document.getElementById("player-wrap").style.display="block";
  document.body.style.overflow="hidden";
}

function closePlayer(){
  log("Player closed","info");
  document.getElementById("player-wrap").style.display="none";
  document.getElementById("playerFrame").src="";
  document.body.style.overflow="";
}
</script>

</body>
</html>
