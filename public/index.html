<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watch Video</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- ========== MONETAG REWARDED AD SDK ========== -->
  <script src='//libtl.com/sdk.js' data-zone='9981288' data-sdk='show_9981288'></script>
  <!-- ============================================== -->
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .container {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
      text-align: center;
    }

    #subtitle {
      color: #888;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }

    /* ========== TOP BANNER AD CONTAINER ========== */
    .ad-banner-top {
      margin-bottom: 20px;
      text-align: center;
    }
    /* ============================================== */

    .btn {
      background: #32b8c6;
      border: none;
      padding: 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      color: #000;
      font-weight: 700;
      width: 100%;
      transition: all 0.2s;
    }

    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #error-msg {
      margin-top: 16px;
      color: #ff4444;
      font-size: 14px;
      text-align: center;
    }

    #video-container {
      display: none;
      margin-top: 20px;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    video {
      width: 100%;
      display: block;
      background: #000;
    }

    .fullscreen-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .fullscreen-btn svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    /* ========== FULLSCREEN STYLES ========== */
    .video-wrapper.fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999 !important;
      border-radius: 0 !important;
    }

    .video-wrapper.fullscreen video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* ======================================= */

    .video-info {
      margin-top: 12px;
      text-align: center;
      font-size: 16px;
    }

    /* ========== BOTTOM BANNER AD CONTAINER ========== */
    .ad-banner-bottom {
      margin-top: 20px;
      text-align: center;
    }
    /* ================================================ */

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.3);
      border-radius: 50%;
      border-top-color: #000;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="video-title">Loading...</h1>
    <p id="subtitle">Preparing video...</p>
    
    <!-- ========== TOP BANNER AD ========== -->
    <div class="ad-banner-top">
      <script async="async" data-cfasync="false" src="//pl27977828.effectivegatecpm.com/257f53d4a564585de9b5b359319941c3/invoke.js"></script>
      <div id="container-257f53d4a564585de9b5b359319941c3"></div>
    </div>
    <!-- =================================== -->
    
    <button id="watch-btn" class="btn" onclick="handleWatchClick()">
      Watch Video ðŸŽ¬
    </button>
    
    <div id="error-msg"></div>
    
    <div id="video-container">
      <div class="video-wrapper" id="video-wrapper">
        <video id="video-player" controls playsinline webkit-playsinline></video>
        
        <button class="fullscreen-btn" id="fullscreen-btn" onclick="toggleFullscreen()">
          <svg id="fullscreen-icon" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
          </svg>
        </button>
      </div>
      <div class="video-info" id="video-info"></div>
      
      <!-- ========== BOTTOM BANNER AD ========== -->
      <div class="ad-banner-bottom">
        <script type="text/javascript">
          atOptions = {
            'key' : '3fc8a11a10d75d1b796ff86d8cc395c9',
            'format' : 'iframe',
            'height' : 50,
            'width' : 320,
            'params' : {}
          };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/3fc8a11a10d75d1b796ff86d8cc395c9/invoke.js"></script>
      </div>
      <!-- ====================================== -->
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    let videoTitle = null;
    let blockId = null;
    let videoId = null;
    let isFullscreen = false;

    const API_URL = window.location.origin + '/api';

    function showError(msg) {
      document.getElementById('error-msg').textContent = msg;
    }

    function getVideoId() {
      const startParam = tg.initDataUnsafe?.start_param || '';
      if (!startParam) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('video_id') || 'vid_1';
      }
      return startParam;
    }

    async function init() {
      videoId = getVideoId();
      
      if (!videoId) {
        showError('No video specified');
        document.getElementById('watch-btn').disabled = true;
        return;
      }

      try {
        document.getElementById('subtitle').textContent = 'Loading...';
        
        const response = await fetch(`${API_URL}/init?video_id=${encodeURIComponent(videoId)}`);
        const data = await response.json();

        if (!data.success) {
          showError(data.error || 'Failed to load video');
          document.getElementById('watch-btn').disabled = true;
          return;
        }

        videoTitle = data.video.title;

        document.getElementById('video-title').textContent = videoTitle || 'Watch Video';
        document.getElementById('subtitle').textContent = 'Click the button to watch';

      } catch (error) {
        showError('Connection error: ' + error.message);
        document.getElementById('watch-btn').disabled = true;
        console.error(error);
      }
    }

    async function handleWatchClick() {
      const btn = document.getElementById('watch-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>Loading Ad...';

      try {
        // ========== MONETAG REWARDED AD ========== 
        // Show rewarded interstitial ad before video
        if (window.show_9981288) {
          await show_9981288();
          console.log('User watched the ad!');
        }
        // =========================================
        
        btn.innerHTML = '<span class="loading"></span>Loading Video...';
        await fetchAndDisplayVideo();

      } catch (error) {
        console.error('Ad error:', error);
        showError('Ad skipped or failed. Loading video...');
        await fetchAndDisplayVideo();
      }
    }

    async function fetchAndDisplayVideo() {
      try {
        const response = await fetch(`${API_URL}/get-video?video_id=${encodeURIComponent(videoId)}`);
        const data = await response.json();

        if (!data.success) {
          showError(data.error || 'Failed to load video');
          return;
        }

        displayVideo(data.video);

      } catch (error) {
        showError('Failed to load video: ' + error.message);
        console.error(error);
      }
    }

    function displayVideo(videoData) {
      document.getElementById('error-msg').textContent = '';
      document.getElementById('watch-btn').style.display = 'none';
      document.getElementById('subtitle').style.display = 'none';
      
      const container = document.getElementById('video-container');
      const player = document.getElementById('video-player');
      const info = document.getElementById('video-info');
      
      player.src = videoData.video_url;
      info.textContent = videoData.title || '';
      
      container.style.display = 'block';
      
      player.load();
      player.play().catch(err => {
        console.log('Autoplay prevented:', err);
      });

      player.addEventListener('error', (e) => {
        const error = player.error;
        showError('Video playback error. Please try again.');
        console.error('Video error:', error);
      });
    }

    function toggleFullscreen() {
      const wrapper = document.getElementById('video-wrapper');
      const player = document.getElementById('video-player');
      const icon = document.getElementById('fullscreen-icon');
      
      if (!isFullscreen) {
        // Enter fullscreen
        wrapper.classList.add('fullscreen');
        
        // Try native fullscreen API
        if (wrapper.requestFullscreen) {
          wrapper.requestFullscreen();
        } else if (wrapper.webkitRequestFullscreen) {
          wrapper.webkitRequestFullscreen();
        } else if (wrapper.mozRequestFullScreen) {
          wrapper.mozRequestFullScreen();
        } else if (wrapper.msRequestFullscreen) {
          wrapper.msRequestFullscreen();
        }
        
        // Change icon to exit fullscreen
        icon.innerHTML = '<path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>';
        
        isFullscreen = true;
      } else {
        // Exit fullscreen
        wrapper.classList.remove('fullscreen');
        
        // Exit native fullscreen
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        
        // Change icon back to enter fullscreen
        icon.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
        
        isFullscreen = false;
      }
    }

    // Handle native fullscreen changes (ESC key, etc.)
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);

    function handleFullscreenChange() {
      const wrapper = document.getElementById('video-wrapper');
      const icon = document.getElementById('fullscreen-icon');
      
      if (!document.fullscreenElement && !document.webkitFullscreenElement && 
          !document.mozFullScreenElement && !document.msFullscreenElement) {
        // Exited fullscreen
        wrapper.classList.remove('fullscreen');
        icon.innerHTML = '<path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>';
        isFullscreen = false;
      }
    }

    init();
  </script>
</body>
</html>
