<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Watch Video</title>

<script src="https://telegram.org/js/telegram-web-app.js?59"></script>
<script src="//libtl.com/sdk.js" data-zone="9981288" data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

html,body{
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
}

/* ============ WATCH UI ============ */
#ui{
  padding:14px;
  background:#f2f3f5;
}
.card{
  max-width:520px;
  margin:auto;
  background:#111;
  color:#fff;
  padding:16px;
  border-radius:14px;
  text-align:center;
}
.card h2{font-size:15px;margin-bottom:6px}
.card p{font-size:12px;opacity:.65;margin-bottom:12px}
.card button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:12px;
  background:#22b8b0;
}

/* ============ PLAYER OVERLAY ============ */
#player{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:999999;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* PLAYER BOX */
#player-box{
  position:relative;
  width:100%;
  max-width:420px;
  aspect-ratio:9/16;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

/* fullscreen player size */
#player.fullscreen #player-box{
  max-width:90vw;
  aspect-ratio:16/9;
}

/* ============ CONTROLS ============ */

/* default controls (on player) */
#controls-player{
  position:absolute;
  top:8px;
  left:8px;
  right:8px;
  display:flex;
  justify-content:space-between;
  z-index:10;
}

/* fullscreen controls (on screen edges) */
#controls-screen{
  display:none;
}

/* common button */
.ctrl-btn{
  padding:6px 10px;
  border:none;
  border-radius:999px;
  background:rgba(0,0,0,.65);
  color:#fff;
  font-size:13px;
  font-weight:600;
  backdrop-filter:blur(6px);
}

/* screen-edge positioning */
#fs-back{
  position:fixed;
  top:calc(10px + var(--tg-safe-area-inset-top));
  left:calc(10px + var(--tg-safe-area-inset-left));
  z-index:1000000;
}
#fs-normal{
  position:fixed;
  right:calc(10px + var(--tg-safe-area-inset-right));
  bottom:calc(30px + var(--tg-safe-area-inset-bottom));
  z-index:1000000;
}

/* ============ IFRAME ============ */
#playerFrame{
  width:100%;
  height:100%;
  border:none;
  transform-origin:center center;
  transition:transform .25s ease;
}

/* normal */
.normal #playerFrame{
  transform:scale(1.02);
}

/* fullscreen rotated */
.fullscreen #playerFrame{
  transform:rotate(90deg) scale(1.02);
}
</style>
</head>

<body>

<!-- WATCH -->
<div id="ui">
  <div class="card">
    <h2 id="title">Loading‚Ä¶</h2>
    <p>Watch ad to unlock video</p>
    <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
  </div>
</div>

<!-- PLAYER -->
<div id="player" class="normal">

  <!-- PLAYER CONTROLS -->
  <div id="player-box">

    <div id="controls-player">
      <button class="ctrl-btn" onclick="goBack()">‚Üê</button>
      <button id="rotateBtn" class="ctrl-btn" onclick="toggleFS()">‚õ∂ Fullscreen</button>
    </div>

    <iframe id="playerFrame" allow="autoplay; fullscreen"></iframe>

  </div>

  <!-- SCREEN CONTROLS (FULLSCREEN ONLY) -->
  <div id="controls-screen">
    <button id="fs-back" class="ctrl-btn" onclick="goBack()">‚úï Close</button>
    <button id="fs-normal" class="ctrl-btn" onclick="toggleFS()">‚ü≥ Normal</button>
  </div>

</div>

<script>
/* ===== TELEGRAM ===== */
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

/* ===== CONFIG ===== */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";
let videoURL = "";

/* ===== LOAD VIDEO ===== */
(async ()=>{
  try{
    const r = await fetch(`${API}?video_id=${videoId}`);
    const d = await r.json();
    if(d.success){
      title.textContent = d.video.title;
      videoURL = d.video.video_url;
    }else title.textContent="Video not found";
  }catch{
    title.textContent="Load error";
  }
})();

/* ===== WATCH ===== */
async function watch(){
  watchBtn.disabled=true;
  watchBtn.textContent="Loading‚Ä¶";
  await showAdSafe(6000);
  openPlayer();
}

/* ===== AD SAFE ===== */
function showAdSafe(ms){
  return new Promise(res=>{
    let done=false;
    const end=()=>{if(!done){done=true;res()}};
    setTimeout(end,ms);
    try{
      show_9981288({onRewarded:end,onClose:end,onError:end});
    }catch{end()}
  });
}

/* ===== PLAYER ===== */
function openPlayer(){
  ui.style.display="none";
  player.style.display="flex";
  player.className="normal";

  playerFrame.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(videoURL);
}

/* ===== BACK ===== */
function goBack(){
  exitFS();
  playerFrame.src="";
  player.style.display="none";
  ui.style.display="block";
  watchBtn.disabled=false;
  watchBtn.textContent="Watch Video üé¨";
}

/* ===== FULLSCREEN ===== */
function toggleFS(){
  if(!player.classList.contains("fullscreen")){
    enterFS();
  }else{
    exitFS();
  }
}

function enterFS(){
  if(tg.isVersionAtLeast("8.0")){
    tg.requestFullscreen();
    tg.lockOrientation();
  }
  player.classList.remove("normal");
  player.classList.add("fullscreen");

  document.getElementById("controls-player").style.display="none";
  document.getElementById("controls-screen").style.display="block";
}

function exitFS(){
  if(tg.isFullscreen){
    tg.exitFullscreen();
    tg.unlockOrientation();
  }
  player.classList.remove("fullscreen");
  player.classList.add("normal");

  document.getElementById("controls-player").style.display="flex";
  document.getElementById("controls-screen").style.display="none";
}
</script>

</body>
</html>
