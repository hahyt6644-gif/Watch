<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Player</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .container {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 8px;
      text-align: center;
    }

    #subtitle {
      color: #888;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }

    .btn {
      background: #32b8c6;
      border: none;
      padding: 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      color: #000;
      font-weight: 700;
      width: 100%;
      transition: all 0.2s;
    }

    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #error-msg {
      margin-top: 16px;
      color: #ff4444;
      font-size: 14px;
      text-align: center;
    }

    #debug-info {
      margin-top: 16px;
      color: #888;
      font-size: 12px;
      font-family: monospace;
      background: #111;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    #video-container {
      display: none;
      margin-top: 20px;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    video {
      width: 100%;
      display: block;
      background: #000;
    }

    .video-info {
      margin-top: 12px;
      text-align: center;
      font-size: 16px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="video-title">Video Player</h1>
    <p id="subtitle">Loading...</p>
    
    <button id="watch-btn" class="btn" onclick="loadVideo()">
      Load Video
    </button>
    
    <div id="error-msg"></div>
    <div id="debug-info"></div>
    
    <div id="video-container">
      <div class="video-wrapper">
        <video id="video-player" controls playsinline webkit-playsinline></video>
      </div>
      <div class="video-info" id="video-info"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    let videoId = null;
    const API_URL = window.location.origin + '/api';

    // Debug logger
    function debug(msg) {
      const debugDiv = document.getElementById('debug-info');
      debugDiv.textContent += msg + '
';
      console.log(msg);
    }

    function showError(msg) {
      document.getElementById('error-msg').textContent = msg;
    }

    function getVideoId() {
      // Try Telegram first
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
        return tg.initDataUnsafe.start_param;
      }
      
      // Fallback to URL query string for browser testing
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('video_id');
      
      if (id) {
        return id;
      }
      
      // Default test video
      return 'vid_1';
    }

    async function init() {
      videoId = getVideoId();
      debug('Video ID: ' + videoId);
      debug('API URL: ' + API_URL);
      
      document.getElementById('subtitle').textContent = 'Click to load video';
    }

    async function loadVideo() {
      const btn = document.getElementById('watch-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>Loading...';
      
      showError('');
      debug('Starting video load...');

      try {
        // Step 1: Get video info
        debug('Fetching video info...');
        const initUrl = `${API_URL}/init?video_id=${encodeURIComponent(videoId)}`;
        debug('Init URL: ' + initUrl);
        
        const initResponse = await fetch(initUrl);
        const initData = await initResponse.json();
        
        debug('Init response: ' + JSON.stringify(initData));
        
        if (!initData.success) {
          throw new Error(initData.error || 'Failed to get video info');
        }

        document.getElementById('video-title').textContent = initData.video.title || 'Video';
        
        // Step 2: Get video URL
        debug('Fetching video URL...');
        const videoUrl = `${API_URL}/get-video?video_id=${encodeURIComponent(videoId)}`;
        debug('Get-video URL: ' + videoUrl);
        
        const videoResponse = await fetch(videoUrl);
        const videoData = await videoResponse.json();
        
        debug('Video response: ' + JSON.stringify(videoData));

        if (!videoData.success) {
          throw new Error(videoData.error || 'Failed to get video URL');
        }

        debug('Video URL: ' + videoData.video.video_url);
        
        // Step 3: Display video
        displayVideo(videoData.video);

      } catch (error) {
        showError('Error: ' + error.message);
        debug('ERROR: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Retry';
      }
    }

    function displayVideo(videoData) {
      debug('Displaying video...');
      
      document.getElementById('error-msg').textContent = '';
      document.getElementById('watch-btn').style.display = 'none';
      document.getElementById('subtitle').style.display = 'none';
      
      const container = document.getElementById('video-container');
      const player = document.getElementById('video-player');
      const info = document.getElementById('video-info');
      
      player.src = videoData.video_url;
      info.textContent = videoData.title || '';
      
      container.style.display = 'block';
      
      debug('Video source set: ' + videoData.video_url);
      
      player.load();
      
      player.addEventListener('loadeddata', () => {
        debug('Video loaded successfully');
        player.play().catch(err => {
          debug('Autoplay prevented: ' + err.message);
        });
      });

      player.addEventListener('error', (e) => {
        const error = player.error;
        debug('Video error: ' + error.code + ' - ' + error.message);
        showError('Video playback error. Error code: ' + error.code);
      });
    }

    init();
  </script>
</body>
</html>
