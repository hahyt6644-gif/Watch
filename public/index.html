<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Watch Video</title>

<script src="https://telegram.org/js/telegram-web-app.js?59"></script>
<script src="//libtl.com/sdk.js" data-zone="9981288" data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

html,body{
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
}

/* ---------- WATCH UI ---------- */
#watchUI{
  padding:16px;
  background:#f2f3f5;
}

.card{
  max-width:520px;
  margin:auto;
  background:#111;
  color:#fff;
  padding:16px;
  border-radius:14px;
  text-align:center;
}

.card h2{font-size:15px;margin-bottom:6px}
.card p{font-size:12px;opacity:.65;margin-bottom:12px}

.card button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:12px;
  background:#22b8b0;
  color:#000;
}

/* ---------- PLAYER ---------- */
#player{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:999999;
}

#playerBox{
  position:absolute;
  inset:0;
  background:#000;
  overflow:hidden;
}

#playerFrame{
  position:absolute;
  width:70%;
  height:100%;
  border:none;
  background:#000;
}

/* ---------- FULLSCREEN (RED BOX) ---------- */
#player.fullscreen{
  padding-top:48px;
}

#player.fullscreen #playerBox{
  height:calc(100% - 48px);
}

#player.fullscreen #playerFrame{
  width:100vh;
  height:100vw;
  transform:rotate(90deg);
  transform-origin:center;
  top:50%;
  left:50%;
  translate:-50% -50%;
}

/* ---------- CONTROLS ---------- */
.ctrl{
  position:absolute;
  background:rgba(0,0,0,.6);
  border:none;
  color:#fff;
  font-size:20px;
  padding:6px 10px;
  border-radius:8px;
  z-index:10;
}

#btnBack{ top:12px; left:12px; }
#btnToggle{ bottom:12px; right:12px; }

#player.fullscreen #btnBack{
  top:10px;
  left:10px;
}

#player.fullscreen #btnToggle{
  bottom:10px;
  right:10px;
}
</style>
</head>

<body>

<!-- WATCH PAGE -->
<div id="watchUI">
  <div class="card">
    <h2 id="title">Loadingâ€¦</h2>
    <p>Watch ad to unlock video</p>
    <button id="watchBtn" disabled>Watch Video ðŸŽ¬</button>
  </div>
</div>

<!-- PLAYER -->
<div id="player">
  <div id="playerBox">

    <iframe id="playerFrame" allow="autoplay; fullscreen"></iframe>

    <button id="btnBack" class="ctrl" onclick="goBack()">âœ•</button>
    <button id="btnToggle" class="ctrl" onclick="toggleFullscreen()">â›¶</button>

  </div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

/* ================= CONFIG ================= */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";

let videoURL = "";
let isFullscreen = false;

/* ================= LOAD TITLE ================= */
(async ()=>{
  try{
    const res = await fetch(`${API}?video_id=${videoId}`);
    const data = await res.json();

    if(data.success && data.video?.video_url){
      title.textContent = data.video.title || "Watch Video";
      videoURL = data.video.video_url;
      watchBtn.disabled = false;
    }else{
      title.textContent = "Video not found";
    }
  }catch(e){
    title.textContent = "Load error";
  }
})();

/* ================= WATCH CLICK ================= */
watchBtn.onclick = async ()=>{
  watchBtn.disabled = true;
  watchBtn.textContent = "Loadingâ€¦";

  await showAdSafe(6000);
  openPlayer();
};

/* ================= SAFE AD ================= */
function showAdSafe(ms){
  return new Promise(resolve=>{
    let done=false;
    const finish=()=>{ if(!done){ done=true; resolve(); } };

    setTimeout(finish, ms);

    try{
      if(typeof show_9981288 === "function"){
        show_9981288({
          onRewarded: finish,
          onClose: finish,
          onError: finish
        });
      }else{
        finish();
      }
    }catch{
      finish();
    }
  });
}

/* ================= PLAYER ================= */
function openPlayer(){
  watchUI.style.display="none";
  player.style.display="block";
  playerFrame.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(videoURL);
}

function goBack(){
  exitFullscreen();
  playerFrame.src="";
  player.style.display="none";
  watchUI.style.display="block";
  watchBtn.disabled=false;
  watchBtn.textContent="Watch Video ðŸŽ¬";
}

/* ================= FULLSCREEN ================= */
function toggleFullscreen(){
  isFullscreen ? exitFullscreen() : enterFullscreen();
}

function enterFullscreen(){
  tg.requestFullscreen?.();
  tg.lockOrientation?.();
  player.classList.add("fullscreen");
  btnToggle.textContent="â¤¢";
  isFullscreen=true;
}

function exitFullscreen(){
  tg.exitFullscreen?.();
  tg.unlockOrientation?.();
  player.classList.remove("fullscreen");
  btnToggle.textContent="â›¶";
  isFullscreen=false;
}
</script>

</body>
</html>
