<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">

<title>Watcher Player</title>

<script src="https://telegram.org/js/telegram-web-app.js?59"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  width:100%;
  height:100%;
  background:#000;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
}

/* INTRO */
#intro{
  position:fixed;
  inset:0;
  background:#f2f3f5;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
}
#intro button{
  padding:12px 24px;
  border:none;
  border-radius:10px;
  background:#000;
  color:#fff;
  font-size:15px;
}

/* PLAYER */
#player{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
}

/* VIDEO BOX */
#videoBox{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:100%;
  max-width:420px;
  aspect-ratio:9/16;
  background:#000;
  overflow:hidden;
  border-radius:14px;
}
.fullscreen #videoBox{
  top:56px;
  left:0;
  transform:none;
  width:100vw;
  height:calc(100vh - 56px);
  max-width:none;
  aspect-ratio:auto;
  border-radius:0;
}

/* IFRAME */
#videoFrame{
  width:100%;
  height:100%;
  border:none;
  transform-origin:center;
}
.normal #videoFrame{transform:scale(1.05)}
.fullscreen #videoFrame{transform:rotate(90deg) scale(1.6)}

/* CONTROLS */
.btn{
  position:fixed;
  padding:7px 14px;
  border:none;
  border-radius:999px;
  background:rgba(0,0,0,.7);
  color:#fff;
  font-size:14px;
  font-weight:600;
  z-index:10000;
}
#btnClose{top:64px;left:16px}
#btnMode{right:16px;top:50%;transform:translateY(-50%)}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro">
  <h2 id="title">Loading…</h2>
  <button id="watchBtn" disabled>▶ Watch Video</button>
</div>

<!-- PLAYER -->
<div id="player" class="normal">
  <div id="videoBox">
    <iframe id="videoFrame" allow="autoplay; fullscreen"></iframe>
  </div>

  <button id="btnClose" class="btn">✕ Close</button>
  <button id="btnMode" class="btn">⛶ Fullscreen</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

/* ===== CONFIG ===== */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";

/* ===== ELEMENTS ===== */
const intro = document.getElementById("intro");
const title = document.getElementById("title");
const watchBtn = document.getElementById("watchBtn");
const player = document.getElementById("player");
const iframe = document.getElementById("videoFrame");
const btnMode = document.getElementById("btnMode");
const btnClose = document.getElementById("btnClose");

let videoURL = "";

/* ===== LOAD VIDEO FROM API ===== */
(async ()=>{
  try{
    const res = await fetch(`${API}?video_id=${videoId}`);
    const data = await res.json();

    if(data.success && data.video?.video_url){
      title.textContent = data.video.title || "Ready to watch";
      videoURL = data.video.video_url;
      watchBtn.disabled = false;
    }else{
      title.textContent = "Video not found";
    }
  }catch{
    title.textContent = "Failed to load video";
  }
})();

/* ===== START ===== */
watchBtn.onclick = ()=>{
  iframe.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(videoURL);

  intro.style.display = "none";
  player.style.display = "block";
};

/* ===== FULLSCREEN ===== */
btnMode.onclick = ()=>{
  if(player.classList.contains("fullscreen")){
    tg.exitFullscreen?.();
    tg.unlockOrientation?.();
    player.classList.remove("fullscreen");
    player.classList.add("normal");
    btnMode.textContent = "⛶ Fullscreen";
  }else{
    tg.requestFullscreen?.();
    tg.lockOrientation?.();
    player.classList.remove("normal");
    player.classList.add("fullscreen");
    btnMode.textContent = "⟳ Normal";
  }
};

/* ===== CLOSE ===== */
btnClose.onclick = ()=>{
  tg.exitFullscreen?.();
  tg.close();
};
</script>

</body>
</html>
