<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Watch Video</title>

<!-- Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag -->
<script src="//libtl.com/sdk.js"
        data-zone="9981288"
        data-sdk="show_9981288"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  background:#000;
  color:#fff;
  padding:12px;
}

/* Card */
.container{
  max-width:500px;
  margin:auto;
  background:#1a1a1a;
  padding:16px;
  border-radius:12px;
  text-align:center;
}

h1{font-size:18px;margin-bottom:6px}
p{font-size:13px;color:#aaa;margin-bottom:12px}

button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(135deg,#32b8c6,#28a0ac);
  color:#000;
}
button:disabled{opacity:.6}

/* Player overlay */
#player-wrap{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:2147483647;
}

#player-wrap iframe{
  width:100%;
  height:100%;
  border:none;
}

/* Back button */
#back-btn{
  position:absolute;
  top:12px;
  left:12px;
  z-index:2147483648;
  padding:8px 12px;
  border-radius:6px;
  border:none;
  background:#fff;
  font-weight:700;
}
</style>
</head>

<body>

<div class="container">
  <h1 id="videoTitle">Loading‚Ä¶</h1>
  <p>Watch ad to unlock video</p>
  <button id="watchBtn" onclick="watch()">Watch Video üé¨</button>
</div>

<!-- Player -->
<div id="player-wrap">
  <button id="back-btn" onclick="closePlayer()">‚Üê Back</button>
  <iframe id="playerFrame"
          allow="autoplay; fullscreen"
          allowfullscreen></iframe>
</div>

<script>
/* ---------- TELEGRAM ---------- */
const tg = window.Telegram?.WebApp || {};
tg.expand?.();
tg.ready?.();

/* ---------- CONFIG ---------- */
const API = "https://watch-two-rho.vercel.app/api/get-video";
const videoId = tg.initDataUnsafe?.start_param || "vid_test";

let shareURL = "";

/* ---------- LOAD TITLE INSTANTLY ---------- */
(async function preload(){
  try{
    const r = await fetch(`${API}?video_id=${videoId}`);
    const d = await r.json();

    if(d.success && d.video){
      document.getElementById("videoTitle").textContent =
        d.video.title || "Watch Video";

      shareURL = d.video.video_url;
    }else{
      document.getElementById("videoTitle").textContent = "Video not found";
    }
  }catch{
    document.getElementById("videoTitle").textContent = "Error loading video";
  }
})();

/* ---------- WATCH FLOW ---------- */
async function watch(){
  const btn = document.getElementById("watchBtn");
  btn.disabled = true;
  btn.textContent = "Loading...";

  /* 1Ô∏è‚É£ Show ad FIRST */
  await showAdSafe();

  /* 2Ô∏è‚É£ Open iframe AFTER ad */
  openPlayer();
}

/* ---------- AD (SAFE) ---------- */
function showAdSafe(timeout=8000){
  return new Promise(resolve=>{
    let done=false;
    const t=setTimeout(()=>{ if(!done){done=true;resolve();}},timeout);

    try{
      show_9981288({
        onRewarded:()=>{if(done)return;done=true;clearTimeout(t);resolve();},
        onClose:()=>{if(done)return;done=true;clearTimeout(t);resolve();},
        onError:()=>{if(done)return;done=true;clearTimeout(t);resolve();}
      });
    }catch{
      clearTimeout(t);
      resolve();
    }
  });
}

/* ---------- PLAYER ---------- */
function openPlayer(){
  const wrap=document.getElementById("player-wrap");
  const iframe=document.getElementById("playerFrame");

  iframe.src =
    "https://playterabox.com/embed/player?url=" +
    encodeURIComponent(shareURL);

  wrap.style.display="block";
  document.body.style.overflow="hidden";

  /* REAL FULLSCREEN */
  if(wrap.requestFullscreen){
    wrap.requestFullscreen();
  }else if(wrap.webkitRequestFullscreen){
    wrap.webkitRequestFullscreen();
  }
}

function closePlayer(){
  const wrap=document.getElementById("player-wrap");
  wrap.style.display="none";
  document.getElementById("playerFrame").src="";
  document.body.style.overflow="";

  if(document.fullscreenElement){
    document.exitFullscreen();
  }
}
</script>

</body>
</html>
